# Pin the base image to a specific hash for maximum reproducibility.
# It will probably still work on newer images, though, unless an update
# changes some compiler optimisations (unlikely).
# ubuntu-20.04
FROM ubuntu@sha256:b25ef49a40b7797937d0d23eca3b0a41701af6757afca23d504d50826f0b37ce

RUN apt update && apt-get install -y \
adduser=3.118ubuntu2 \
apt=2.0.5 \
autoconf=2.69-11.1 \
automake=1:1.16.1-4ubuntu6 \
autopoint=0.19.8.1-10build1 \
autotools-dev=20180224.1 \
base-files=11ubuntu5.3 \
base-passwd=3.5.47 \
bash=5.0-6ubuntu1.1 \
binutils=2.34-6ubuntu1.3 \
binutils-common=2.34-6ubuntu1.3 \
binutils-x86-64-linux-gnu=2.34-6ubuntu1.3 \
bsdmainutils=11.1.2ubuntu3 \
bsdutils=1:2.34-0.1ubuntu9.1 \
bzip2=1.0.8-2 \
ca-certificates=20211016~20.04.1 \
coreutils=8.30-3ubuntu2 \
cpp=4:9.3.0-1ubuntu2 \
cpp-9=9.4.0-1ubuntu1~20.04.1 \
dash=0.5.10.2-6 \
debconf=1.5.73 \
debhelper=12.10ubuntu1 \
debianutils=4.9.1 \
dh-autoreconf=19 \
dh-exec=0.23.2 \
dh-strip-nondeterminism=1.7.0-1 \
diffutils=1:3.7-3 \
dpkg=1.19.7ubuntu3 \
dpkg-dev=1.19.7ubuntu3.2 \
dwz=0.13-5 \
e2fsprogs=1.45.5-2ubuntu1 \
fdisk=2.34-0.1ubuntu9.1 \
file=1:5.38-4 \
findutils=4.7.0-1ubuntu1 \
g++=4:9.3.0-1ubuntu2 \
g++-9=9.4.0-1ubuntu1~20.04.1 \
gcc=4:9.3.0-1ubuntu2 \
gcc-10-base=10.3.0-1ubuntu1~20.04 \
gcc-9=9.4.0-1ubuntu1~20.04.1 \
gcc-9-base=9.4.0-1ubuntu1~20.04.1 \
gettext=0.19.8.1-10build1 \
gettext-base=0.19.8.1-10build1 \
git=1:2.25.1-1ubuntu3.6 \
git-man=1:2.25.1-1ubuntu3.6 \
gpgv=2.2.19-3ubuntu2.1 \
grep=3.4-1 \
groff-base=1.22.4-4build1 \
gzip=1.10-0ubuntu4 \
hostname=3.23 \
init-system-helpers=1.57 \
intltool-debian=0.35.0+20060710.5 \
libacl1=2.2.53-6 \
libapt-pkg6.0=2.0.5 \
libarchive-zip-perl=1.67-2 \
libasan5=9.4.0-1ubuntu1~20.04.1 \
libasn1-8-heimdal=7.7.0+dfsg-1ubuntu1.1 \
libatomic1=10.3.0-1ubuntu1~20.04 \
libattr1=1:2.4.48-5 \
libaudit-common=1:2.8.5-2ubuntu6 \
libaudit1=1:2.8.5-2ubuntu6 \
libbinutils=2.34-6ubuntu1.3 \
libblkid1=2.34-0.1ubuntu9.1 \
libbrotli1=1.0.7-6ubuntu0.1 \
libbsd0=0.10.0-1 \
libbz2-1.0=1.0.8-2 \
libc-bin=2.31-0ubuntu9.2 \
libc-dev-bin=2.31-0ubuntu9.9 \
libc6=2.31-0ubuntu9.9 \
libc6-dev=2.31-0ubuntu9.9 \
libcap-ng0=0.7.9-2.1build1 \
libcc1-0=10.3.0-1ubuntu1~20.04 \
libcom-err2=1.45.5-2ubuntu1 \
libcroco3=0.6.13-1 \
libcrypt-dev=1:4.4.10-10ubuntu4 \
libcrypt1=1:4.4.10-10ubuntu4 \
libctf-nobfd0=2.34-6ubuntu1.3 \
libctf0=2.34-6ubuntu1.3 \
libcurl3-gnutls=7.68.0-1ubuntu2.14 \
libdb5.3=5.3.28+dfsg1-0.6ubuntu2 \
libdebconfclient0=0.251ubuntu1 \
libdebhelper-perl=12.10ubuntu1 \
libdpkg-perl=1.19.7ubuntu3.2 \
libelf1=0.176-1.1build1 \
liberror-perl=0.17029-1 \
libexpat1=2.2.9-1ubuntu0.4 \
libext2fs2=1.45.5-2ubuntu1 \
libfdisk1=2.34-0.1ubuntu9.1 \
libffi7=3.3-4 \
libfile-stripnondeterminism-perl=1.7.0-1 \
libgcc-9-dev=9.4.0-1ubuntu1~20.04.1 \
libgcc-s1=10.3.0-1ubuntu1~20.04 \
libgcrypt20=1.8.5-5ubuntu1 \
libgdbm-compat4=1.18.1-5 \
libgdbm6=1.18.1-5 \
libglib2.0-0=2.64.6-1~ubuntu20.04.4 \
libgmp-dev=2:6.2.0+dfsg-4ubuntu0.1 \
libgmp10=2:6.2.0+dfsg-4ubuntu0.1 \
libgmpxx4ldbl=2:6.2.0+dfsg-4ubuntu0.1 \
libgnutls30=3.6.13-2ubuntu1.3 \
libgomp1=10.3.0-1ubuntu1~20.04 \
libgpg-error0=1.37-1 \
libgssapi-krb5-2=1.17-6ubuntu4.1 \
libgssapi3-heimdal=7.7.0+dfsg-1ubuntu1.1 \
libhcrypto4-heimdal=7.7.0+dfsg-1ubuntu1.1 \
libheimbase1-heimdal=7.7.0+dfsg-1ubuntu1.1 \
libheimntlm0-heimdal=7.7.0+dfsg-1ubuntu1.1 \
libhogweed5=3.5.1+really3.5.1-2ubuntu0.1 \
libhx509-5-heimdal=7.7.0+dfsg-1ubuntu1.1 \
libicu66=66.1-2ubuntu2.1 \
libidn2-0=2.2.0-2 \
libisl22=0.22.1-1 \
libitm1=10.3.0-1ubuntu1~20.04 \
libk5crypto3=1.17-6ubuntu4.1 \
libkeyutils1=1.6-6ubuntu1.1 \
libkrb5-26-heimdal=7.7.0+dfsg-1ubuntu1.1 \
libkrb5-3=1.17-6ubuntu4.1 \
libkrb5support0=1.17-6ubuntu4.1 \
libldap-2.4-2=2.4.49+dfsg-2ubuntu1.9 \
libldap-common=2.4.49+dfsg-2ubuntu1.9 \
liblsan0=10.3.0-1ubuntu1~20.04 \
liblz4-1=1.9.2-2 \
liblzma5=5.2.4-1ubuntu1 \
libmagic-mgc=1:5.38-4 \
libmagic1=1:5.38-4 \
libmount1=2.34-0.1ubuntu9.1 \
libmpc3=1.1.0-1 \
libmpfr6=4.0.2-1 \
libncurses6=6.2-0ubuntu2 \
libncursesw6=6.2-0ubuntu2 \
libnettle7=3.5.1+really3.5.1-2ubuntu0.1 \
libnghttp2-14=1.40.0-1build1 \
libp11-kit0=0.23.20-1ubuntu0.1 \
libpam-modules=1.3.1-5ubuntu4.1 \
libpam-modules-bin=1.3.1-5ubuntu4.1 \
libpam-runtime=1.3.1-5ubuntu4.1 \
libpam0g=1.3.1-5ubuntu4.1 \
libpcre2-8-0=10.34-7 \
libpcre3=2:8.39-12build1 \
libperl5.30=5.30.0-9ubuntu0.3 \
libpipeline1=1.5.2-2build1 \
libprocps8=2:3.3.16-1ubuntu2.1 \
libpsl5=0.21.0-1ubuntu1 \
libquadmath0=10.3.0-1ubuntu1~20.04 \
libroken18-heimdal=7.7.0+dfsg-1ubuntu1.1 \
librtmp1=2.4+20151223.gitfa8646d.1-2build1 \
libsasl2-2=2.1.27+dfsg-2ubuntu0.1 \
libsasl2-modules-db=2.1.27+dfsg-2ubuntu0.1 \
libseccomp-dev=2.5.1-1ubuntu1~20.04.2 \
libseccomp2=2.5.1-1ubuntu1~20.04.2 \
libselinux1=3.0-1build2 \
libsemanage-common=3.0-1build2 \
libsemanage1=3.0-1build2 \
libsepol1=3.0-1 \
libsigsegv2=2.12-2 \
libsmartcols1=2.34-0.1ubuntu9.1 \
libsqlite3-0=3.31.1-4ubuntu0.5 \
libss2=1.45.5-2ubuntu1 \
libssh-4=0.9.3-2ubuntu2.2 \
libssl1.1=1.1.1f-1ubuntu2.16 \
libstdc++-9-dev=9.4.0-1ubuntu1~20.04.1 \
libstdc++6=10.3.0-1ubuntu1~20.04 \
libsub-override-perl=0.09-2 \
libsystemd0=245.4-4ubuntu3.6 \
libtasn1-6=4.16.0-2 \
libtinfo6=6.2-0ubuntu2 \
libtool=2.4.6-14 \
libtsan0=10.3.0-1ubuntu1~20.04 \
libubsan1=10.3.0-1ubuntu1~20.04 \
libuchardet0=0.0.6-3build1 \
libudev1=245.4-4ubuntu3.6 \
libunistring2=0.9.10-2 \
libuuid1=2.34-0.1ubuntu9.1 \
libwind0-heimdal=7.7.0+dfsg-1ubuntu1.1 \
libxml2=2.9.10+dfsg-5ubuntu0.20.04.4 \
libzstd1=1.4.4+dfsg-3ubuntu0.1 \
linux-libc-dev=5.4.0-132.148 \
login=1:4.8.1-1ubuntu5.20.04 \
logsave=1.45.5-2ubuntu1 \
lsb-base=11.1.0ubuntu2 \
m4=1.4.18-4 \
make=4.2.1-1.2 \
man-db=2.9.1-1 \
mawk=1.3.4.20200120-2 \
mount=2.34-0.1ubuntu9.1 \
ncurses-base=6.2-0ubuntu2 \
ncurses-bin=6.2-0ubuntu2 \
openssl=1.1.1f-1ubuntu2.16 \
passwd=1:4.8.1-1ubuntu5.20.04 \
patch=2.7.6-6 \
perl=5.30.0-9ubuntu0.3 \
perl-base=5.30.0-9ubuntu0.3 \
perl-modules-5.30=5.30.0-9ubuntu0.3 \
pkg-config=0.29.1-0ubuntu4 \
po-debconf=1.0.21 \
procps=2:3.3.16-1ubuntu2.1 \
sed=4.7-1 \
sensible-utils=0.0.12+nmu1 \
sysvinit-utils=2.96-2.1ubuntu1 \
tar=1.30+dfsg-7ubuntu0.20.04.1 \
tzdata=2022f-0ubuntu0.20.04.1 \
ubuntu-keyring=2020.02.11.4 \
unzip=6.0-25ubuntu1.1 \
util-linux=2.34-0.1ubuntu9.1 \
wget=1.20.3-1ubuntu2 \
xz-utils=5.2.4-1ubuntu1.1 \
zlib1g=1:1.2.11.dfsg-2ubuntu1.2

RUN wget -O /usr/bin/opam https://github.com/ocaml/opam/releases/download/2.1.3/opam-2.1.3-i686-linux && chmod 755 /usr/bin/opam

ENV OPAMROOT=/tmp
ENV OPAMCONFIRMLEVEL=unsafe-yes
# Pin last known-good version for reproducible builds.
# Remove this line (and the base image pin above) if you want to test with the
# latest versions.
RUN opam init --disable-sandboxing -a --bare https://github.com/ocaml/opam-repository.git#685eb4efcebfa671660e55d76dea017f00fed4d9
RUN opam switch create myswitch 4.14.0
RUN opam exec -- opam install -y mirage opam-monorepo ocaml-solo5
RUN mkdir /tmp/orb-build
ADD config.ml /tmp/orb-build/config.ml
WORKDIR /tmp/orb-build
CMD opam exec -- sh -exc 'mirage configure -t xen --allocation-policy=best-fit && make depend && make tar'
